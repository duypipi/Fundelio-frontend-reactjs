<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Story Editor – Blank Builder (Vanilla)</title>
  <style>
    :root {
      --primary:#0894E2;
    }
    * { box-sizing:border-box }
    body { margin:0; background:#f5f6f7; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; color:#111827 }
    .layout { display:grid; grid-template-columns: 280px 1fr; min-height:100vh; gap:16px; padding:16px }
    .sidebar {
      position:sticky; top:12px; align-self:start;
      background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:12px;
      max-height: calc(100vh - 24px); overflow:auto;
    }
    .sidebar h3 { margin:6px 8px 10px; font-size:14px; color:#374151 }
    .nav-item {
      display:flex; gap:8px; align-items:center; margin-bottom:8px;
      padding:6px; border-radius:10px; transition:background .15s;
    }
    .nav-item:hover { background:#f3f4f6; cursor:pointer }
    .nav-item input {
      flex:1; border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px;
      font-size:14px; background:#fff;
    }
    .add-btn {
      display:flex; align-items:center; justify-content:center;
      width:100%; padding:10px; margin-top:8px;
      border:1px dashed #c7cbd1; border-radius:10px; background:#fff; cursor:pointer;
    }
    .add-btn:hover { border-color:#9aa0a6; background:#fafafa }
    .main {
      max-width: 980px; margin: 0 auto;
    }
    .toolbar {
      position:sticky; top:12px; z-index:10;
      display:flex; gap:8px; flex-wrap:wrap;
      background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:8px; margin-bottom:10px;
    }
    .toolbar button, .toolbar label, .toolbar input[type="color"] {
      border:1px solid #e5e7eb; background:#fff; border-radius:10px; padding:8px 10px; font-size:14px; cursor:pointer;
    }
    .toolbar input[type="color"] { padding:4px; width:44px; height:36px; }
    .doc {
      background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:24px; margin-bottom:18px;
    }
    .doc .title {
      width:100%; padding:10px 12px; font-size:20px; font-weight:600; border:1px solid #e5e7eb; border-radius:12px; margin-bottom:14px;
    }
    .editor {
      min-height:40vh; padding:16px; border:1px solid #e5e7eb; border-radius:12px;
    }
    .editor:focus { outline:2px solid var(--primary); outline-offset:2px }
    .editor img { max-width:100%; height:auto; display:block; margin:16px auto; border-radius:12px }
    .editor iframe { width:100%; aspect-ratio:16/9; border:0; border-radius:12px; margin:16px 0 }
    .muted { color:#6b7280; font-size:12px }
    .hidden { display:none }
  </style>
</head>
<body>

<div class="layout">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <h3>Mục lục</h3>
    <div id="navList"></div>
    <button class="add-btn" id="addBlankLeft">+ Thêm blank</button>
    <div class="muted" style="margin-top:8px;padding:0 6px">
      • Click vào ô tiêu đề để sửa<br/>
      • Click vùng ngoài ô để cuộn tới blank
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="toolbar" id="toolbar">
      <button data-cmd="bold"><b>B</b></button>
      <button data-cmd="italic"><i>I</i></button>
      <button id="h2">H2</button>
      <button id="makelink">Link</button>
      <label>
        Ảnh/GIF
        <input type="file" id="imgPicker" accept="image/*" class="hidden">
      </label>
      <input type="color" id="foreColor" title="Màu chữ">
      <button id="saveBtn">Lưu (console)</button>
    </div>

    <div id="docs"></div>

    <button class="add-btn" id="addBlankBottom">+ Thêm blank</button>
  </main>
</div>

<script>
  // ------- State -------
  const docsEl = document.getElementById('docs');
  const navListEl = document.getElementById('navList');
  const addBlankLeft = document.getElementById('addBlankLeft');
  const addBlankBottom = document.getElementById('addBlankBottom');
  const imgPicker = document.getElementById('imgPicker');
  const colorInput = document.getElementById('foreColor');
  const saveBtn = document.getElementById('saveBtn');

  let activeEditor = null;           // contenteditable đang focus
  const blanks = new Map();          // id -> { wrapper, titleInputTop, editor, navRow, navInput }

  // ------- Utils -------
  const uid = () => 'blank-' + Math.random().toString(36).slice(2, 9);

  function smoothScrollTo(el) {
    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
    // Đặt focus vào editor của blank đó sau khi cuộn
    setTimeout(() => {
      const b = blanks.get(el.id);
      b?.editor?.focus();
    }, 350);
  }

  function createNavRow(id, initialTitle) {
    const row = document.createElement('div');
    row.className = 'nav-item';
    row.dataset.target = id;

    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = 'Tiêu đề...';
    input.value = initialTitle || 'Untitled';
    row.appendChild(input);

    // Click vùng row (không phải input) sẽ cuộn
    row.addEventListener('click', (e) => {
      if (e.target === input) return; // đang sửa tiêu đề
      const target = document.getElementById(id);
      if (target) smoothScrollTo(target);
    });

    // Sửa ở sidebar => cập nhật title trên blank
    input.addEventListener('input', () => {
      const b = blanks.get(id);
      if (b) b.titleInputTop.value = input.value || 'Untitled';
    });

    navListEl.appendChild(row);
    return { row, input };
  }

  function handleDropFactory(editor) {
    return function handleDrop(e) {
      e.preventDefault();
      if (!e.dataTransfer.files.length) return;
      const file = e.dataTransfer.files[0];
      if (!file.type.startsWith('image/')) return;
      const url = URL.createObjectURL(file); // Giữ GIF animate
      const img = document.createElement('img');
      img.src = url;
      placeBlock(editor, img);
    };
  }

  function handlePasteFactory(editor) {
    return function handlePaste(e) {
      const text = e.clipboardData.getData('text/plain');
      if (text && /^https?:\/\//i.test(text)) {
        const iframe = buildVideoEmbed(text);
        if (iframe) {
          e.preventDefault();
          placeBlock(editor, iframe);
        }
      }
      // nếu có ảnh trong clipboard, trình duyệt sẽ tự paste
    };
  }

  function buildVideoEmbed(url) {
    try {
      const u = new URL(url);
      if (u.hostname.includes('youtube.com')) {
        const v = u.searchParams.get('v');
        if (!v) return null;
        const ifr = document.createElement('iframe');
        ifr.src = `https://www.youtube.com/embed/${v}`;
        ifr.allowFullscreen = true;
        return ifr;
      }
      if (u.hostname === 'youtu.be') {
        const id = u.pathname.slice(1);
        if (!id) return null;
        const ifr = document.createElement('iframe');
        ifr.src = `https://www.youtube.com/embed/${id}`;
        ifr.allowFullscreen = true;
        return ifr;
      }
      if (u.hostname.includes('vimeo.com')) {
        const id = u.pathname.split('/').filter(Boolean).pop();
        if (!id) return null;
        const ifr = document.createElement('iframe');
        ifr.src = `https://player.vimeo.com/video/${id}`;
        ifr.allowFullscreen = true;
        return ifr;
      }
      return null;
    } catch { return null; }
  }

  function placeBlock(editor, node) {
    const sel = window.getSelection();
    if (sel && sel.rangeCount) {
      const range = sel.getRangeAt(0);
      if (!editor.contains(range.commonAncestorContainer)) {
        editor.appendChild(node);
        return;
      }
      range.collapse(false);
      range.insertNode(node);
      range.setStartAfter(node);
      range.setEndAfter(node);
      sel.removeAllRanges();
      sel.addRange(range);
    } else {
      editor.appendChild(node);
    }
  }

  function createBlank(initialTitle = 'Untitled') {
    const id = uid();

    // Wrapper
    const wrapper = document.createElement('section');
    wrapper.className = 'doc';
    wrapper.id = id;

    // Title (trên blank)
    const title = document.createElement('input');
    title.className = 'title';
    title.placeholder = 'Tiêu đề blank...';
    title.value = initialTitle;

    // Editor area
    const editor = document.createElement('div');
    editor.className = 'editor';
    editor.contentEditable = 'true';
    editor.spellcheck = false;
    editor.dataset.blankId = id;

    // Events
    editor.addEventListener('focusin', () => { activeEditor = editor; });
    editor.addEventListener('click', () => { activeEditor = editor; });
    editor.addEventListener('drop', handleDropFactory(editor));
    editor.addEventListener('paste', handlePasteFactory(editor));

    // Đồng bộ tiêu đề: từ blank -> sidebar
    title.addEventListener('input', () => {
      const b = blanks.get(id);
      if (b) b.navInput.value = title.value || 'Untitled';
    });

    wrapper.appendChild(title);
    wrapper.appendChild(editor);
    docsEl.appendChild(wrapper);

    // Tạo nav item
    const { row, input } = createNavRow(id, initialTitle);

    // Lưu node vào state
    blanks.set(id, {
      wrapper, titleInputTop: title, editor,
      navRow: row, navInput: input
    });

    return id;
  }

  // ------- Toolbar -------
  // Bold/Italic execCommand: đủ cho demo
  document.getElementById('toolbar').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    if (!activeEditor && !['saveBtn'].includes(btn.id)) return;

    const cmd = btn.dataset.cmd;
    if (cmd) {
      document.execCommand(cmd, false, null);
    }
  });

  document.getElementById('h2').addEventListener('click', () => {
    if (!activeEditor) return;
    // Chèn H2 block
    const h = document.createElement('h2');
    h.textContent = 'Tiêu đề cấp 2';
    placeBlock(activeEditor, h);
  });

  document.getElementById('makelink').addEventListener('click', () => {
    if (!activeEditor) return;
    const url = prompt('Dán link YouTube/Vimeo:');
    if (!url) return;
    const iframe = buildVideoEmbed(url);
    if (iframe) placeBlock(activeEditor, iframe);
    else alert('Không nhận diện được link video.');
  });

  // Màu chữ
  colorInput.addEventListener('input', () => {
    if (!activeEditor) return;
    document.execCommand('foreColor', false, colorInput.value);
  });

  // Ảnh/GIF
  imgPicker.addEventListener('change', () => {
    if (!activeEditor) return;
    const file = imgPicker.files?.[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) return;
    const url = URL.createObjectURL(file); // giữ GIF động
    const img = document.createElement('img');
    img.src = url;
    placeBlock(activeEditor, img);
    imgPicker.value = '';
  });

  // Lưu demo (HTML từng blank)
  saveBtn.addEventListener('click', () => {
    const payload = [];
    blanks.forEach((b, id) => {
      payload.push({
        id,
        title: b.titleInputTop.value,
        html: b.editor.innerHTML
      });
    });
    console.log('SAVE payload:', payload);
    alert('Đã log ra console nội dung các blank (HTML). Khuyến nghị sanitize trước khi lưu.');
  });

  // ------- Add blank buttons -------
  function addAndJump() {
    const id = createBlank('Untitled');
    const section = document.getElementById(id);
    smoothScrollTo(section);
  }
  addBlankLeft.addEventListener('click', addAndJump);
  addBlankBottom.addEventListener('click', addAndJump);

  // ------- Init: tạo 1 blank mặc định -------
  const firstId = createBlank('Giới thiệu');
  const first = blanks.get(firstId);
  if (first) { first.editor.innerHTML = '<p>Gõ nội dung câu chuyện dự án ở đây…</p>'; first.editor.focus(); activeEditor = first.editor; }
</script>
</body>
</html>
